# E2E Тесты

E2E тесты для AI Contact Form на Playwright.

## Перед запуском

Убедитесь, что:

1. Установлены зависимости: `npm install`
2. Установлены браузеры Playwright: `npx playwright install chromium`
3. Настроен `.env.local` с переменными:
   - `GEMINI_API_KEY`
   - `NEXT_PUBLIC_SUPABASE_URL`
   - `NEXT_PUBLIC_SUPABASE_ANON_KEY`

## Запуск тестов

### Запустить все тесты
```bash
npm test
```

### Запустить в UI режиме
```bash
npm run test:ui
```

### Запустить с видимым браузером
```bash
npx playwright test --headed
```

### Запустить конкретный тест
```bash
npx playwright test contact-form.spec.ts
```

### Запустить с отладкой
```bash
npx playwright test --debug
```

## Покрытие тестами

### 1. Отправка формы 
- Пользователь вводит имя при первом посещении
- Валидация полей формы
- Успешная отправка формы
- Отображение сообщения об успехе
- Очистка формы после отправки

### 2. AI улучшение 
- Пользователь вводит сообщение
- Нажимает "Улучшить с помощью AI"
- Ожидает AI-улучшенное сообщение
- Просматривает улучшенное сообщение в preview
- Применяет улучшенное сообщение к форме

**Примечание:** Тест пропускается, если `GEMINI_API_KEY` не настроен в `.env.local`

### 3. Валидация формы 
- Валидация email
- Валидация длины сообщения (50-1000 символов)
- Отображение счетчика символов
- Состояние отключенной кнопки отправки

### 4. Отмена AI улучшения 
- Пользователь может отменить AI улучшение
- Исходное сообщение сохраняется

**Примечание:** Тест пропускается, если `GEMINI_API_KEY` не настроен

### 5. Навигация 
- Пользователь может перейти на страницу истории отправок

## Тестовые данные

Тесты используют:
- Имя: "Test User"
- Email: "test@example.com"
- Тема: "Сообщение об ошибке"
- Сообщение: Тестовое сообщение на русском

## Примечания

- Тесты автоматически очищают localStorage перед каждым тестом
- **AI тесты пропускаются без `GEMINI_API_KEY`** - это нормально
- AI тесты имеют timeout 30 секунд для ответа API
- Dev сервер автоматически запускается Playwright перед тестами
- Тесты запускаются на `http://localhost:3000` по умолчанию

### Запуск без AI ключа

Если нет Gemini API ключа, тесты:
- ✅ Запустят 3 основных теста (отправка формы, валидация, навигация)
- ⏭️ Пропустят 2 AI теста с сообщением: "Skipping AI test: GEMINI_API_KEY not configured"

Это ожидаемое поведение и позволяет тестировать основной функционал без AI.

## Решение проблем

### Тесты падают с ошибкой "Target closed"
Убедиться, что dev сервер запускается корректно и приложение загружается.

### AI тесты timeout
Проверить, что `GEMINI_API_KEY` валиден и API доступен.

### Ошибки базы данных
Проверить конфигурацию Supabase и что таблицы созданы правильно.
